#  Semana 14 - Tutorial de FastAPI con Pandas para Crear una API de Resultados Analíticos

Este tutorial muestra cómo crear una API rápida con **FastAPI** para exponer resultados analíticos de un **DataFrame de Pandas** en formato JSON. FastAPI es un framework moderno y eficiente, mientras que Pandas permite manipular datos fácilmente. El ejemplo incluye la creación de un DataFrame, procesamiento básico y exposición de resultados a través de endpoints.

## Requisitos previos

Para seguir este tutorial, necesitas:

- Python 3.7 o superior.
- Instalar las dependencias:
  ```bash
  pip install fastapi pandas uvicorn
  ```
  - **FastAPI**: Framework para crear la API.
  - **Pandas**: Para manipulación de datos.
  - **Uvicorn**: Servidor ASGI para ejecutar la API.

## Estructura del tutorial

1. Crear un DataFrame de ejemplo con Pandas.
2. Configurar una API con FastAPI.
3. Crear endpoints para devolver resultados analíticos.
4. Probar la API con herramientas como `curl` o un navegador.
5. Explorar la documentación automática de FastAPI.

## Código de la API

El siguiente código crea una API con FastAPI que expone un DataFrame con análisis básico, como estadísticas descriptivas y filtrado por categoría.

```python
from fastapi import FastAPI
import pandas as pd
from pydantic import BaseModel
from typing import Optional

# Inicializar la aplicación FastAPI
app = FastAPI(title="API de Resultados Analíticos con Pandas")

# Crear un DataFrame de ejemplo
data = {
    'Producto': ['Producto A', 'Producto B', 'Producto C', 'Producto D'],
    'Categoría': ['Electrónica', 'Ropa', 'Alimentos', 'Electrónica'],
    'Ventas': [100, 150, 200, 80],
    'Precio': [50.0, 30.0, 20.0, 100.0]
}
df = pd.DataFrame(data)
df['Ingresos'] = df['Ventas'] * df['Precio']

# Modelo Pydantic para validar parámetros de entrada (opcional)
class FiltroCategoria(BaseModel):
    categoria: Optional[str] = None

# Endpoint raíz
@app.get("/")
def read_root():
    return {"message": "Bienvenido a la API de resultados analíticos con Pandas"}

# Endpoint para obtener el DataFrame completo
@app.get("/datos")
def get_datos():
    return df.to_dict(orient="records")

# Endpoint para estadísticas descriptivas
@app.get("/estadisticas")
def get_estadisticas():
    estadisticas = df.describe().to_dict()
    return estadisticas

# Endpoint para filtrar por categoría
@app.post("/filtro")
def filtrar_por_categoria(filtro: FiltroCategoria):
    if filtro.categoria:
        df_filtrado = df[df['Categoría'] == filtro.categoria]
    else:
        df_filtrado = df
    return df_filtrado.to_dict(orient="records")

# Endpoint para obtener ingresos totales por categoría
@app.get("/ingresos_por_categoria")
def get_ingresos_por_categoria():
    ingresos = df.groupby('Categoría')['Ingresos'].sum().to_dict()
    return ingresos
```

## Explicación del código

### Configuración inicial
- Se importa `FastAPI` para crear la API y `pandas` para manejar el DataFrame.
- Se crea un DataFrame de ejemplo con columnas `Producto`, `Categoría`, `Ventas`, `Precio` e `Ingresos` (calculado como `Ventas * Precio`).
- Se usa **Pydantic** (`BaseModel`) para validar parámetros de entrada en el endpoint de filtrado.

### Endpoints
- **`GET /`**: Devuelve un mensaje de bienvenida.
- **`GET /datos`**: Devuelve el DataFrame completo en formato JSON (usando `to_dict(orient="records")`).
- **`GET /estadisticas`**: Devuelve estadísticas descriptivas del DataFrame (`describe()`).
- **`POST /filtro`**: Filtra el DataFrame por categoría usando un cuerpo JSON.
- **`GET /ingresos_por_categoria`**: Agrupa los ingresos totales por categoría con `groupby`.

### Uso de Pydantic
- El modelo `FiltroCategoria` valida el parámetro `categoria` en el endpoint `/filtro`. Si no se proporciona, se devuelven todos los datos.

## Ejecutar la API

1. **Guarda el código**:
   - Guarda el código en un archivo, por ejemplo, `api_pandas.py`.

2. **Inicia el servidor**:
   - Ejecuta en la terminal:
     ```bash
     uvicorn api_pandas:app --reload
     ```
   - Esto inicia la API en `http://127.0.0.1:8000`. El parámetro `--reload` recarga el servidor al modificar el código.

3. **Prueba los endpoints**:
   - **Documentación automática**:
     - Visita `http://127.0.0.1:8000/docs` en un navegador para explorar la interfaz Swagger de FastAPI.
   - **Usar `curl`**:
     - Obtener todos los datos:
       ```bash
       curl http://127.0.0.1:8000/datos
       ```
       **Respuesta**:
       ```json
       [
           {"Producto": "Producto A", "Categoría": "Electrónica", "Ventas": 100, "Precio": 50.0, "Ingresos": 5000.0},
           {"Producto": "Producto B", "Categoría": "Ropa", "Ventas": 150, "Precio": 30.0, "Ingresos": 4500.0},
           {"Producto": "Producto C", "Categoría": "Alimentos", "Ventas": 200, "Precio": 20.0, "Ingresos": 4000.0},
           {"Producto": "Producto D", "Categoría": "Electrónica", "Ventas": 80, "Precio": 100.0, "Ingresos": 8000.0}
       ]
       ```
     - Obtener estadísticas:
       ```bash
       curl http://127.0.0.1:8000/estadisticas
       ```
       **Respuesta**:
       ```json
       {
           "Ventas": {"count": 4.0, "mean": 132.5, "std": 51.7385, ...},
           "Precio": {"count": 4.0, "mean": 50.0, "std": 35.3553, ...},
           "Ingresos": {"count": 4.0, "mean": 5375.0, "std": 1856.9788, ...}
       }
       ```
     - Filtrar por categoría:
       ```bash
       curl -X POST http://127.0.0.1:8000/filtro -H "Content-Type: application/json" -d '{"categoria": "Electrónica"}'
       ```
       **Respuesta**:
       ```json
       [
           {"Producto": "Producto A", "Categoría": "Electrónica", "Ventas": 100, "Precio": 50.0, "Ingresos": 5000.0},
           {"Producto": "Producto D", "Categoría": "Electrónica", "Ventas": 80, "Precio": 100.0, "Ingresos": 8000.0}
       ]
       ```
     - Ingresos por categoría:
       ```bash
       curl http://127.0.0.1:8000/ingresos_por_categoria
       ```
       **Respuesta**:
       ```json
       {"Alimentos": 4000.0, "Electrónica": 13000.0, "Ropa": 4500.0}
       ```

## Opciones avanzadas

- **Añadir más endpoints**:
  - Por ejemplo, para los productos con mayores ventas:
    ```python
    @app.get("/top_productos")
    def get_top_productos(top_n: int = 3):
        return df.nlargest(top_n, 'Ventas').to_dict(orient="records")
    ```
    - Prueba: `http://127.0.0.1:8000/top_productos?top_n=2`.

- **Cargar datos desde un archivo**:
  - Usa un archivo CSV en lugar de un DataFrame estático:
    ```python
    df = pd.read_csv("ruta_al_archivo.csv")
    ```

- **Autenticación básica**:
  - Implementa seguridad con `fastapi.security` para APIs privadas.

- **Integración con bases de datos**:
  - Usa `SQLAlchemy` o `sqlite3` para cargar datos desde una base de datos.

## Ventajas de FastAPI con Pandas

- **Rápido**: FastAPI es asíncrono y eficiente.
- **Documentación automática**: Swagger UI en `/docs` facilita probar y documentar la API.
- **Validación de datos**: Pydantic asegura que los datos de entrada sean correctos.
- **Integración con Pandas**: Los DataFrames se convierten fácilmente a JSON.

