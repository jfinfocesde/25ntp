#  Semana 11 - Operaciones de Agregar, Agrupar y Fusionar en Pandas

## üìö Introducci√≥n

En esta semana aprenderemos las operaciones fundamentales para combinar y manipular DataFrames en Pandas. Estas operaciones son esenciales para el an√°lisis de datos cuando trabajamos con m√∫ltiples fuentes de informaci√≥n o necesitamos realizar an√°lisis agregados.

## üéØ Objetivos de Aprendizaje

Al finalizar esta semana, ser√°s capaz de:

- ‚úÖ Agregar datos usando `append()` y `concat()`
- ‚úÖ Agrupar datos con `groupby()` y aplicar funciones de agregaci√≥n
- ‚úÖ Fusionar DataFrames usando `merge()` y `join()`
- ‚úÖ Aplicar estas operaciones en casos pr√°cticos de an√°lisis de datos

## üîó Operaciones de Agregar

### 1.1 Usando `append()` (Deprecado en versiones recientes)

```python
# Crear DataFrames de ejemplo
df1 = pd.DataFrame({
    'A': [1, 2, 3],
    'B': ['a', 'b', 'c']
})

df2 = pd.DataFrame({
    'A': [4, 5, 6],
    'B': ['d', 'e', 'f']
})

# Nota: append() est√° deprecado, usar concat() en su lugar
# resultado = df1.append(df2, ignore_index=True)
```

### 1.2 Usando `concat()` - M√©todo Recomendado

```python
# Concatenaci√≥n vertical (agregar filas)
resultado_vertical = pd.concat([df1, df2], ignore_index=True)
print("Concatenaci√≥n vertical:")
print(resultado_vertical)

# Concatenaci√≥n horizontal (agregar columnas)
df3 = pd.DataFrame({
    'C': [10, 20, 30],
    'D': ['x', 'y', 'z']
})

resultado_horizontal = pd.concat([df1, df3], axis=1)
print("\nConcatenaci√≥n horizontal:")
print(resultado_horizontal)
```

### 1.3 Opciones Avanzadas de `concat()`

```python
# Concatenaci√≥n con keys para identificar origen
resultado_con_keys = pd.concat([df1, df2], keys=['grupo1', 'grupo2'])
print("Concatenaci√≥n con keys:")
print(resultado_con_keys)

# Concatenaci√≥n solo de intersecci√≥n de columnas
df4 = pd.DataFrame({
    'A': [7, 8],
    'C': [70, 80]
})

resultado_inner = pd.concat([df1, df4], join='inner')
print("\nConcatenaci√≥n inner join:")
print(resultado_inner)
```

---

## üìä Operaciones de Agrupaci√≥n

### 2.1 Conceptos B√°sicos de `groupby()`

```python
# Crear DataFrame de ejemplo para agrupaci√≥n
ventas = pd.DataFrame({
    'vendedor': ['Ana', 'Carlos', 'Ana', 'Carlos', 'Ana', 'Carlos'],
    'producto': ['A', 'A', 'B', 'B', 'A', 'C'],
    'cantidad': [10, 15, 8, 12, 5, 20],
    'precio': [100, 100, 150, 150, 100, 200],
    'region': ['Norte', 'Sur', 'Norte', 'Sur', 'Norte', 'Sur']
})

print("DataFrame de ventas:")
print(ventas)

# Agrupaci√≥n b√°sica por vendedor
grupo_vendedor = ventas.groupby('vendedor')
print("\nVentas totales por vendedor:")
print(grupo_vendedor['cantidad'].sum())
```

### 2.2 Funciones de Agregaci√≥n

```python
# M√∫ltiples funciones de agregaci√≥n
print("Estad√≠sticas por vendedor:")
print(grupo_vendedor['cantidad'].agg(['sum', 'mean', 'count', 'std']))

# Agregaci√≥n personalizada
def rango(serie):
    return serie.max() - serie.min()

print("\nRango de cantidades por vendedor:")
print(grupo_vendedor['cantidad'].agg(rango))

# M√∫ltiples columnas con diferentes agregaciones
agregaciones = {
    'cantidad': ['sum', 'mean'],
    'precio': ['mean', 'max']
}

resultado_multi = grupo_vendedor.agg(agregaciones)
print("\nAgregaciones m√∫ltiples:")
print(resultado_multi)
```

### 2.3 Agrupaci√≥n por M√∫ltiples Columnas

```python
# Agrupaci√≥n por vendedor y regi√≥n
grupo_multiple = ventas.groupby(['vendedor', 'region'])
print("Ventas por vendedor y regi√≥n:")
print(grupo_multiple['cantidad'].sum())

# Desagrupar el √≠ndice
resultado_reset = grupo_multiple['cantidad'].sum().reset_index()
print("\nResultado con √≠ndice simple:")
print(resultado_reset)
```

### 2.4 Transformaciones y Filtros

```python
# Transform: mantiene el tama√±o original del DataFrame
ventas['cantidad_promedio_vendedor'] = grupo_vendedor['cantidad'].transform('mean')
print("DataFrame con promedio por vendedor:")
print(ventas)

# Filter: filtra grupos completos
grupos_activos = grupo_vendedor.filter(lambda x: x['cantidad'].sum() > 20)
print("\nVendedores con ventas totales > 20:")
print(grupos_activos)

# Apply: aplica funci√≥n a cada grupo
def calcular_total(grupo):
    return (grupo['cantidad'] * grupo['precio']).sum()

total_por_vendedor = grupo_vendedor.apply(calcular_total)
print("\nTotal de ventas por vendedor:")
print(total_por_vendedor)
```

---

## üîÑ Operaciones de Fusi√≥n

### 3.1 Preparaci√≥n de Datos para Fusi√≥n

```python
# DataFrames de ejemplo
empleados = pd.DataFrame({
    'id_empleado': [1, 2, 3, 4],
    'nombre': ['Ana', 'Carlos', 'Mar√≠a', 'Luis'],
    'departamento_id': [10, 20, 10, 30]
})

departamentos = pd.DataFrame({
    'id_departamento': [10, 20, 30, 40],
    'nombre_dept': ['Ventas', 'Marketing', 'IT', 'RRHH'],
    'presupuesto': [100000, 80000, 120000, 60000]
})

print("Empleados:")
print(empleados)
print("\nDepartamentos:")
print(departamentos)
```

### 3.2 Tipos de `merge()`

```python
# Inner join (intersecci√≥n)
inner_merge = pd.merge(
    empleados, 
    departamentos, 
    left_on='departamento_id', 
    right_on='id_departamento',
    how='inner'
)
print("Inner merge:")
print(inner_merge)

# Left join (todos los empleados)
left_merge = pd.merge(
    empleados, 
    departamentos, 
    left_on='departamento_id', 
    right_on='id_departamento',
    how='left'
)
print("\nLeft merge:")
print(left_merge)

# Right join (todos los departamentos)
right_merge = pd.merge(
    empleados, 
    departamentos, 
    left_on='departamento_id', 
    right_on='id_departamento',
    how='right'
)
print("\nRight merge:")
print(right_merge)

# Outer join (todos los registros)
outer_merge = pd.merge(
    empleados, 
    departamentos, 
    left_on='departamento_id', 
    right_on='id_departamento',
    how='outer'
)
print("\nOuter merge:")
print(outer_merge)
```

### 3.3 Fusi√≥n con √çndices

```python
# Preparar DataFrames con √≠ndices
empleados_idx = empleados.set_index('id_empleado')
salarios = pd.DataFrame({
    'salario': [50000, 60000, 55000, 65000],
    'bonus': [5000, 8000, 5500, 7000]
}, index=[1, 2, 3, 4])

# Merge usando √≠ndices
merge_index = pd.merge(
    empleados_idx, 
    salarios, 
    left_index=True, 
    right_index=True
)
print("Merge usando √≠ndices:")
print(merge_index)
```

### 3.4 Usando `join()`

```python
# join() es m√°s directo para fusionar por √≠ndices
resultado_join = empleados_idx.join(salarios)
print("Resultado con join():")
print(resultado_join)

# join() con sufijos para columnas duplicadas
empleados_v2 = pd.DataFrame({
    'nombre': ['Ana Garc√≠a', 'Carlos L√≥pez', 'Mar√≠a Rodr√≠guez', 'Luis Mart√≠n'],
    'edad': [28, 35, 31, 29]
}, index=[1, 2, 3, 4])

resultado_sufijos = empleados_idx.join(empleados_v2, rsuffix='_v2')
print("\nJoin con sufijos:")
print(resultado_sufijos)
```

---

## üí° Ejemplos Pr√°cticos

### Ejemplo 1: An√°lisis de Ventas por Regi√≥n

```python
# Datos de ventas m√°s completos
np.random.seed(42)
ventas_completas = pd.DataFrame({
    'fecha': pd.date_range('2024-01-01', periods=100, freq='D'),
    'vendedor': np.random.choice(['Ana', 'Carlos', 'Mar√≠a', 'Luis'], 100),
    'producto': np.random.choice(['Laptop', 'Mouse', 'Teclado', 'Monitor'], 100),
    'cantidad': np.random.randint(1, 10, 100),
    'precio_unitario': np.random.choice([100, 25, 50, 300], 100),
    'region': np.random.choice(['Norte', 'Sur', 'Este', 'Oeste'], 100)
})

# Calcular total de ventas
ventas_completas['total'] = ventas_completas['cantidad'] * ventas_completas['precio_unitario']

# An√°lisis por regi√≥n y mes
ventas_completas['mes'] = ventas_completas['fecha'].dt.month
analisis_regional = ventas_completas.groupby(['region', 'mes']).agg({
    'total': 'sum',
    'cantidad': 'sum',
    'vendedor': 'nunique'
}).round(2)

print("An√°lisis de ventas por regi√≥n y mes:")
print(analisis_regional.head(10))
```

### Ejemplo 2: Combinando Datos de M√∫ltiples Fuentes

```python
# Informaci√≥n de productos
productos = pd.DataFrame({
    'producto': ['Laptop', 'Mouse', 'Teclado', 'Monitor'],
    'categoria': ['Computadoras', 'Accesorios', 'Accesorios', 'Computadoras'],
    'costo': [800, 15, 30, 200]
})

# Fusionar con datos de ventas
ventas_con_productos = pd.merge(
    ventas_completas, 
    productos, 
    on='producto'
)

# Calcular margen de ganancia
ventas_con_productos['margen'] = ventas_con_productos['precio_unitario'] - ventas_con_productos['costo']
ventas_con_productos['margen_porcentaje'] = (ventas_con_productos['margen'] / ventas_con_productos['precio_unitario'] * 100).round(2)

# An√°lisis de rentabilidad por categor√≠a
rentabilidad = ventas_con_productos.groupby('categoria').agg({
    'margen': 'sum',
    'total': 'sum',
    'cantidad': 'sum'
}).round(2)

rentabilidad['margen_promedio'] = (rentabilidad['margen'] / rentabilidad['total'] * 100).round(2)

print("An√°lisis de rentabilidad por categor√≠a:")
print(rentabilidad)
```

---
